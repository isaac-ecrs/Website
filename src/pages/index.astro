---
import { getCollection, getEntry } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import Hero from '../components/Hero.astro';
import FeatureCard from '../components/FeatureCard.astro';
import EventHighlight from '../components/EventHighlight.astro';

import { renderMarkdown } from '../lib/markdown';

// Import images
import heroBg from '../assets/images/hero-bg.jpg';
import { Image } from 'astro:assets';
import placeholderImage from '../assets/images/landing-page/what-we-do.jpg';

// All available images for dynamic loading
const allImages = import.meta.glob<{ default: ImageMetadata }>(
  '../assets/images/**/*.{jpg,jpeg,png,webp,avif}',
  { eager: true }
);

// Dynamic image loader from CMS path
function getImageFromPath(imagePath: string | undefined): ImageMetadata {
  if (!imagePath) return placeholderImage;

  try {
    const assetsPath = imagePath.replace('/assets/', '../assets/');
    const imageModule = allImages[assetsPath];
    return imageModule?.default || placeholderImage;
  } catch {
    return placeholderImage;
  }
}

// Get content from collections
const homePage = await getEntry('pages', 'home');
if (!homePage || homePage.data.pageType !== 'home') {
  throw new Error('Home page content not found');
}

// Type assertion for TypeScript - we've verified pageType above
const homeData = homePage.data;

// Load feature card images from CMS
const featureCardImages = homeData.featureCards.map((card) =>
  getImageFromPath(card.image)
);

// Load whatWeDo image from CMS
const whatWeDoImage = getImageFromPath(homeData.whatWeDo.image);

// Get the next upcoming event (earliest future event)
const now = new Date();
const allEvents = await getCollection('events');
const upcomingEvents = allEvents
  .filter((e) => new Date(e.data.startDate) > now)
  .sort(
    (a, b) =>
      new Date(a.data.startDate).getTime() -
      new Date(b.data.startDate).getTime()
  );

const featuredEvent = upcomingEvents.length > 0 ? upcomingEvents[0] : null;

// Load featured event image
const featuredEventImage = featuredEvent
  ? getImageFromPath(featuredEvent.data.heroImage)
  : placeholderImage;
---

<BaseLayout title="Home" description="ECRS - Come to Play. Play to Learn">
  <!-- SECTION 1: Hero -->
  <Hero
    title={homeData.hero.title}
    subtitle={homeData.hero.subtitle}
    backgroundImage={heroBg}
    ctaText={homeData.hero.ctaText}
    ctaLink={homeData.hero.ctaLink}
  />

  <!-- SECTION 2: Three Feature Cards -->
  <section class="section section--cream">
    <div class="container">
      <div class="grid-3">
        {
          homeData.featureCards.map((card, index) => (
            <FeatureCard
              image={featureCardImages[index]}
              title={card.title}
              description={card.description}
              link={card.link || '#'}
              linkText={card.linkText}
            />
          ))
        }
      </div>
    </div>
  </section>

  <!-- SECTION 3: About ECRS Narrative (rendered from markdown) -->
  <section class="section section--white" id="about">
    <div class="container">
      <div class="about-content" set:html={renderMarkdown(homeData.about)} />
    </div>
  </section>

  <!-- SECTION 4: What We Do -->
  <section class="section section--tan" id="programs">
    <div class="container">
      <h2 class="text-center">What We Do</h2>

      <div class="what-we-do-content">
        <div class="what-we-do-image" data-reveal="left">
          <Image src={whatWeDoImage} alt="What We Do" />
        </div>
        <div class="what-we-do-text" data-reveal="right">
          <p class="section-intro">
            {homeData.whatWeDo.description}
          </p>

          <div
            class="activities-list"
            set:html={renderMarkdown(homeData.whatWeDo.activities)}
          />
        </div>
      </div>
    </div>
  </section>

  <!-- SECTION 5: Event Highlight (Next Upcoming Event) -->
  {
    featuredEvent &&
      (() => {
        const eventUrl = `/events/${featuredEvent.data.eventSlug}`;
        return (
          <EventHighlight
            title={featuredEvent.data.title}
            date={`${new Date(featuredEvent.data.startDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })} – ${new Date(featuredEvent.data.endDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}`}
            description={
              featuredEvent.data.shortDescription ||
              'Event details coming soon.'
            }
            image={featuredEventImage}
            link={eventUrl}
          />
        );
      })()
  }

  <!-- SECTION 6: Footer (included in BaseLayout) -->
</BaseLayout>

<style lang="scss">
  @use '../styles/variables' as *;
  @use '../styles/mixins' as *;

  .about-content {
    max-width: 800px;
    margin: 0 auto;

    h2 {
      color: $color-primary;
      margin-bottom: 1.5em;
    }

    .about-text {
      p {
        font-size: 18px;
        line-height: 1.8;
        margin-bottom: 1.5em;

        &:last-child {
          margin-bottom: 0;
        }
      }
    }
  }

  .section-intro {
    max-width: 700px;
    margin: 0 auto 3em;
    font-size: 18px;
    color: rgba($color-text-dark, 0.7);
  }

  .what-we-do-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 3em;
    align-items: start;
    margin-top: 2em;

    @include mobile {
      grid-template-columns: 1fr;
      gap: 2em;
    }
  }

  .what-we-do-image {
    img {
      width: 100%;
      height: auto;
      border-radius: 3px;
      box-shadow: $shadow-image;
    }
  }

  .what-we-do-text {
    .section-intro {
      margin-bottom: 1.5em;
    }
  }

  .activities-list {
    :global(ul) {
      list-style: none;
      padding-left: 0;
    }

    :global(li) {
      font-size: 18px;
      line-height: 1.8;
      margin-bottom: 0.5em;
      color: $color-text-dark;
      padding-left: 1.5em;
      position: relative;
      list-style: none;

      &::before {
        content: '→';
        position: absolute;
        left: 0;
        color: $color-accent;
        font-weight: bold;
      }
    }
  }
</style>
