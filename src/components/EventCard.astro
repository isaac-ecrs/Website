---
import Card from './Card.astro';
import { marked } from 'marked';

interface Props {
  event: any;
  isPast?: boolean;
  showImage?: boolean;
  href: string;
}

const { event, isPast = false, showImage = true, href } = Astro.props;

// Check if event actually has a valid image
const hasValidImage =
  showImage &&
  typeof event.data.heroImage === 'string' &&
  event.data.heroImage.trim().length > 0;

const startDate = new Date(event.data.startDate);
const endDate = new Date(event.data.endDate);

const startDateStr = startDate.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
  hour: '2-digit',
  minute: '2-digit',
});

const endDateStr = endDate.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
  hour: '2-digit',
  minute: '2-digit',
});

const location = `${event.data.location.venue} • ${event.data.location.city}, ${event.data.location.state}`;

// Check if we have a valid street address (not TBD, not empty, not just a description)
const hasValidAddress =
  event.data.location.address &&
  event.data.location.address.trim().length > 0 &&
  !event.data.location.address.toLowerCase().includes('tbd') &&
  !event.data.location.address.toLowerCase().includes('location in');

// Check if it's a one-day event for icon selection
const isOneDay = startDate.toDateString() === endDate.toDateString();

// Process shortDescription markdown if it exists
const processedDescription = event.data.shortDescription
  ? marked.parse(event.data.shortDescription, { async: false })
  : null;
---

<Card
  href={href}
  variant="horizontal"
  isPast={isPast}
  hasMedia={hasValidImage}
  data-reveal="bottom"
>
  {
    hasValidImage && (
      <div slot="media" class="event-image">
        <img src={event.data.heroImage} alt={event.data.title} />
      </div>
    )
  }

  <div slot="content" class="event-content">
    <h3 class="event-title">{event.data.title}</h3>

    {
      processedDescription && (
        <div class="event-short-description" set:html={processedDescription} />
      )
    }

    <div class="event-info-section">
      <div class="event-info-item">
        <i
          class={`fas ${isOneDay ? 'fa-calendar-day' : 'fa-calendar-days'}`}
          aria-label="Event date"></i>
        <span>{startDateStr} – {endDateStr}</span>
      </div>

      {
        event.data.location.website && (
          <div class="event-info-item">
            <i class="fas fa-globe" aria-label="Venue website" />
            <a href={event.data.location.website}>
              {event.data.location.venue}
            </a>
          </div>
        )
      }

      <div class="event-info-item">
        <i class="fas fa-map-marker-alt" aria-label="Location"></i>
        {
          hasValidAddress ? (
            <a
              href={`https://www.google.com/maps/dir/?api=1&destination=${encodeURI(location)}`}
            >
              {event.data.location.address}, {event.data.location.city},{' '}
              {event.data.location.state} {event.data.location.zip}
            </a>
          ) : (
            <span>
              {event.data.location.address &&
                `${event.data.location.address}, `}
              {event.data.location.city}, {event.data.location.state}{' '}
              {event.data.location.zip}
            </span>
          )
        }
      </div>
    </div>
  </div>

  <span slot="cta" class="card-link">Learn More →</span>
</Card>

<style lang="scss">
  @use '../styles/variables' as *;
  @use '../styles/mixins' as *;

  .event-image {
    width: 100%;
    height: 200px;
    overflow: hidden;
    border-radius: 3px;

    img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 3px;
    }
  }

  .event-content {
    .event-title {
      color: $color-primary;
      margin-bottom: 0.75em;
      margin-top: 0;
    }

    .event-short-description {
      color: $color-text-dark;
      font-size: 15px;
      line-height: 1.6;
      margin-bottom: 1em;
      margin-top: 0;
    }

    .event-info-section {
      display: flex;
      flex-direction: column;
      gap: 0.75em;
    }

    .event-info-item {
      display: flex;
      gap: 0.75em;
      align-items: center;
      font-size: 15px;

      i {
        color: $color-primary;
        min-width: 16px;
      }

      a {
        color: $color-secondary;
        text-decoration: none;

        &:hover {
          text-decoration: underline;
        }
      }

      span {
        color: $color-text-dark;
      }
    }
  }
</style>
