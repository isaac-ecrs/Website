---
interface Props {
  targetDate: Date;
  eventTitle: string;
}

const { targetDate, eventTitle } = Astro.props;
const targetTimestamp = targetDate.getTime();
---

<div
  class="countdown-float"
  data-target={targetTimestamp}
  data-title={eventTitle}
  role="button"
  tabindex="0"
  aria-label="Toggle countdown timer"
>
  <div class="countdown-content">
    <div class="countdown-label">Time until {eventTitle}</div>
    <div class="countdown-display" data-display-container>
      <!-- Content dynamically populated based on time remaining -->
    </div>
  </div>
  <div class="countdown-toggle" aria-hidden="true">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="16"
      height="16"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <polyline points="6 9 12 15 18 9"></polyline>
    </svg>
  </div>
</div>

<script>
  function initCountdown() {
    const container = document.querySelector('.countdown-float') as HTMLElement;
    if (!container) return;

    const targetTimestamp = parseInt(container.dataset.target || '0');
    const displayContainer = container.querySelector(
      '[data-display-container]'
    );
    if (!displayContainer) return;

    // Time constants
    const MS_PER_SECOND = 1000;
    const MS_PER_MINUTE = MS_PER_SECOND * 60;
    const MS_PER_HOUR = MS_PER_MINUTE * 60;
    const MS_PER_DAY = MS_PER_HOUR * 24;
    const MS_PER_WEEK = MS_PER_DAY * 7;
    const MS_PER_MONTH = MS_PER_DAY * 30.44; // Average month
    const MS_PER_YEAR = MS_PER_DAY * 365.25; // Account for leap years

    type UnitConfig = { value: number; singular: string; plural: string };
    let currentMode = '';
    let currentText = '';

    function formatFluentText(units: UnitConfig[]): string {
      // Filter out zero values
      const nonZero = units.filter((u) => u.value > 0);
      if (nonZero.length === 0) return 'now';

      const parts = nonZero.map(
        (u) => `${u.value} ${u.value === 1 ? u.singular : u.plural}`
      );

      if (parts.length === 1) {
        return parts[0];
      } else if (parts.length === 2) {
        return `${parts[0]} and ${parts[1]}`;
      } else {
        const last = parts.pop();
        return `${parts.join(', ')}, and ${last}`;
      }
    }

    function renderFluentText(text: string) {
      displayContainer!.innerHTML = `<span class="countdown-text">${text}</span>`;
      displayContainer!.classList.remove('countdown-units');
      displayContainer!.classList.add('countdown-fluent');
    }

    function renderUnits(units: UnitConfig[]) {
      // Filter out zero values for grid display too
      const nonZero = units.filter((u) => u.value > 0);
      displayContainer!.innerHTML = '';
      displayContainer!.classList.remove('countdown-fluent');
      displayContainer!.classList.add('countdown-units');
      nonZero.forEach((unit) => {
        const el = document.createElement('div');
        el.className = 'countdown-unit';
        el.innerHTML = `
          <span class="countdown-value">${unit.value}</span>
          <span class="countdown-name">${unit.value === 1 ? unit.singular : unit.plural}</span>
        `;
        displayContainer!.appendChild(el);
      });
    }

    function updateCountdown() {
      const now = Date.now();
      const diff = targetTimestamp - now;

      if (diff <= 0) {
        container.classList.add('countdown-float--ended');
        renderFluentText('Event has started!');
        return;
      }

      let units: UnitConfig[] = [];
      let newMode = '';
      let useFluent = true;

      if (diff >= MS_PER_YEAR) {
        // More than a year: show years, months, weeks
        const years = Math.floor(diff / MS_PER_YEAR);
        const remainingAfterYears = diff % MS_PER_YEAR;
        const months = Math.floor(remainingAfterYears / MS_PER_MONTH);
        const remainingAfterMonths = remainingAfterYears % MS_PER_MONTH;
        const weeks = Math.floor(remainingAfterMonths / MS_PER_WEEK);

        units = [
          { value: years, singular: 'year', plural: 'years' },
          { value: months, singular: 'month', plural: 'months' },
          { value: weeks, singular: 'week', plural: 'weeks' },
        ];
        newMode = 'years';
      } else if (diff >= MS_PER_MONTH) {
        // More than a month: show months, weeks, days
        const months = Math.floor(diff / MS_PER_MONTH);
        const remainingAfterMonths = diff % MS_PER_MONTH;
        const weeks = Math.floor(remainingAfterMonths / MS_PER_WEEK);
        const remainingAfterWeeks = remainingAfterMonths % MS_PER_WEEK;
        const days = Math.floor(remainingAfterWeeks / MS_PER_DAY);

        units = [
          { value: months, singular: 'month', plural: 'months' },
          { value: weeks, singular: 'week', plural: 'weeks' },
          { value: days, singular: 'day', plural: 'days' },
        ];
        newMode = 'months';
      } else if (diff >= MS_PER_WEEK) {
        // More than a week: show weeks, days
        const weeks = Math.floor(diff / MS_PER_WEEK);
        const remainingAfterWeeks = diff % MS_PER_WEEK;
        const days = Math.floor(remainingAfterWeeks / MS_PER_DAY);

        units = [
          { value: weeks, singular: 'week', plural: 'weeks' },
          { value: days, singular: 'day', plural: 'days' },
        ];
        newMode = 'weeks';
      } else {
        // Less than a week: show days, hours, minutes, seconds (grid format)
        const days = Math.floor(diff / MS_PER_DAY);
        const hours = Math.floor((diff % MS_PER_DAY) / MS_PER_HOUR);
        const minutes = Math.floor((diff % MS_PER_HOUR) / MS_PER_MINUTE);
        const seconds = Math.floor((diff % MS_PER_MINUTE) / MS_PER_SECOND);

        units = [
          { value: days, singular: 'Day', plural: 'Days' },
          { value: hours, singular: 'Hr', plural: 'Hrs' },
          { value: minutes, singular: 'Min', plural: 'Min' },
          { value: seconds, singular: 'Sec', plural: 'Sec' },
        ];
        newMode = 'days';
        useFluent = false;
      }

      if (useFluent) {
        const newText = formatFluentText(units);
        if (newMode !== currentMode || newText !== currentText) {
          currentMode = newMode;
          currentText = newText;
          renderFluentText(newText);
        }
      } else {
        // Grid mode for final countdown
        if (newMode !== currentMode) {
          currentMode = newMode;
          renderUnits(units);
        } else {
          // Update existing values (filter zeros)
          const nonZero = units.filter((u) => u.value > 0);
          const unitEls = displayContainer!.querySelectorAll('.countdown-unit');

          // If number of displayed units changed, re-render
          if (unitEls.length !== nonZero.length) {
            renderUnits(units);
          } else {
            const valueEls =
              displayContainer!.querySelectorAll('.countdown-value');
            const nameEls =
              displayContainer!.querySelectorAll('.countdown-name');
            nonZero.forEach((unit, i) => {
              if (valueEls[i]) valueEls[i].textContent = unit.value.toString();
              if (nameEls[i])
                nameEls[i].textContent =
                  unit.value === 1 ? unit.singular : unit.plural;
            });
          }
        }
      }
    }

    // Toggle minimized state on click
    container.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      container.classList.toggle('countdown-float--minimized');
    });

    // Handle keyboard accessibility
    container.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        e.stopPropagation();
        container.classList.toggle('countdown-float--minimized');
      }
    });

    // Initial update and interval
    updateCountdown();
    setInterval(updateCountdown, 1000);
  }

  // Initialize on page load and for Astro view transitions
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCountdown);
  } else {
    initCountdown();
  }

  // Handle Astro view transitions
  document.addEventListener('astro:after-swap', initCountdown);
</script>

<style lang="scss">
  @use '../styles/variables' as *;
  @use '../styles/mixins' as *;

  .countdown-float {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: $color-dark-brown;
    color: white;
    padding: 1em 1.5em;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    transition:
      transform 0.3s ease,
      opacity 0.3s ease,
      box-shadow 0.3s ease;
    cursor: pointer;
    user-select: none;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1em;

    &:hover {
      box-shadow: 0 6px 28px rgba(0, 0, 0, 0.4);
      transform: translateY(-2px);
    }

    &:focus-visible {
      outline: 2px solid $color-accent;
      outline-offset: 2px;
    }

    @include mobile {
      bottom: 16px;
      right: 16px;
      left: 16px;
      padding: 0.75em 1em;
    }

    &--minimized {
      .countdown-content {
        display: none;
      }

      padding: 0.75em 1em;

      .countdown-toggle svg {
        transform: rotate(180deg);
      }

      &::before {
        content: attr(data-title);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: $font-weight-bold;
      }
    }

    &--ended {
      background: $color-primary;

      .countdown-label::after {
        content: ' - Event Started!';
      }
    }
  }

  .countdown-content {
    flex: 1;
  }

  .countdown-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1px;
    opacity: 0.8;
    margin-bottom: 0.5em;
    text-align: center;
  }

  .countdown-display {
    text-align: center;

    // Use :global for dynamically-generated content
    :global(.countdown-text) {
      font-size: 1.25rem;
      font-weight: $font-weight-bold;
      font-family: $font-heading;
      color: $color-accent;

      @include mobile {
        font-size: 1.1rem;
      }
    }

    :global(.countdown-unit) {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 48px;

      @include mobile {
        min-width: 40px;
      }
    }

    :global(.countdown-value) {
      font-size: 28px;
      font-weight: $font-weight-bold;
      font-family: $font-heading;
      line-height: 1;
      color: $color-accent;

      @include mobile {
        font-size: 22px;
      }
    }

    :global(.countdown-name) {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.7;
      margin-top: 4px;
    }

    &:global(.countdown-units) {
      display: flex;
      gap: 1em;
      justify-content: center;

      @include mobile {
        gap: 0.75em;
      }
    }
  }

  .countdown-toggle {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    color: white;
    opacity: 0.8;
    transition: opacity 0.2s;

    svg {
      transition: transform 0.3s ease;
    }
  }

  .countdown-float:hover .countdown-toggle {
    opacity: 1;
  }
</style>
